@using ENTITY.Articulos
@using ENTITY.Pedidos
@using DAL.Interfaces
@using GUI.Services
@inject IArticuloDAO ArticuloDAO
@inject CarritoService Carrito

@if (mostrarModal)
{
    <div class="modal-overlay" @onclick="Cerrar">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>Agregar al Carrito</h3>
                <button class="btn-close" @onclick="Cerrar">✕</button>
            </div>

            <div class="modal-body">
                @if (cargando)
                {
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando variantes...</p>
                    </div>
                }
                else if (errorMessage != null)
                {
                    <div class="error-message">
                        <p>❌ @errorMessage</p>
                    </div>
                }
                else if (articuloDetalle != null)
                {
                    <!-- Información del producto -->
                    <div class="producto-info">
                        <h4>@articuloDetalle.Nombre</h4>
                        <p class="marca">@articuloDetalle.Marca</p>
                        <p class="precio">@articuloDetalle.PrecioBase.ToString("C")</p>
                    </div>

                    <!-- Selección de talla -->
                    <div class="form-group">
                        <label>Talla</label>
                        <div class="opciones-grid">
                            @foreach (var talla in tallasDisponibles)
                            {
                                <button class="opcion-btn @(tallaSeleccionada == talla ? "active" : "")"
                                        @onclick="() => SeleccionarTalla(talla)">
                                    @talla
                                </button>
                            }
                        </div>
                    </div>

                    <!-- Selección de color -->
                    @if (!string.IsNullOrEmpty(tallaSeleccionada))
                    {
                        <div class="form-group">
                            <label>Color</label>
                            <div class="opciones-grid">
                                @foreach (var color in coloresDisponibles)
                                {
                                    <button class="opcion-btn @(colorSeleccionado == color ? "active" : "")"
                                            @onclick="() => SeleccionarColor(color)">
                                        @color
                                    </button>
                                }
                            </div>
                        </div>
                    }

                    <!-- Stock disponible -->
                    @if (varianteSeleccionada != null)
                    {
                        <div class="stock-info">
                            <p>
                                <strong>Stock disponible:</strong> @varianteSeleccionada.Stock unidades
                            </p>
                            <p class="sku">SKU: @varianteSeleccionada.CodigoSKU</p>
                        </div>

                        <!-- Cantidad -->
                        <div class="form-group">
                            <label>Cantidad</label>
                            <div class="cantidad-controls">
                                <button class="btn-cantidad" @onclick="DisminuirCantidad">−</button>
                                <input type="number"
                                       class="cantidad-input"
                                       @bind="cantidad"
                                       min="1"
                                       max="@varianteSeleccionada.Stock" />
                                <button class="btn-cantidad" @onclick="AumentarCantidad">+</button>
                            </div>
                        </div>
                    }

                    <!-- Mensaje de error -->
                    @if (!string.IsNullOrEmpty(mensajeError))
                    {
                        <div class="error-message">
                            <p>❌ @mensajeError</p>
                        </div>
                    }

                    <!-- Mensaje de éxito -->
                    @if (mostrarExito)
                    {
                        <div class="success-message">
                            <p>✓ Producto agregado al carrito</p>
                        </div>
                    }
                }
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" @onclick="Cerrar">
                    Cancelar
                </button>
                <button class="btn-primary"
                        @onclick="AgregarAlCarrito"
                        disabled="@(varianteSeleccionada == null || agregando)">
                    @if (agregando)
                    {
                        <span>Agregando...</span>
                    }
                    else
                    {
                        <span>🛒 Agregar al Carrito</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
    }

    .modal-content {
        background: white;
        border-radius: 16px;
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 25px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
    }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
        }

    .btn-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
        padding: 4px 8px;
        border-radius: 8px;
        transition: all 0.2s;
    }

        .btn-close:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

    .modal-body {
        padding: 20px;
    }

    .loading {
        text-align: center;
        padding: 40px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .producto-info {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e5e7eb;
    }

        .producto-info h4 {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .producto-info .marca {
            color: #667eea;
            font-size: 14px;
            font-weight: 500;
            margin: 0 0 8px 0;
        }

        .producto-info .precio {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin: 0;
        }

    .form-group {
        margin-bottom: 20px;
    }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

    .opciones-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 8px;
    }

    .opcion-btn {
        padding: 10px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        color: #374151;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
    }

        .opcion-btn:hover {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .opcion-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

    .stock-info {
        padding: 12px;
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 8px;
        margin-bottom: 20px;
    }

        .stock-info p {
            margin: 4px 0;
            font-size: 14px;
            color: #166534;
        }

        .stock-info .sku {
            font-size: 12px;
            color: #15803d;
        }

    .cantidad-controls {
        display: flex;
        align-items: center;
        gap: 12px;
        justify-content: center;
    }

    .btn-cantidad {
        width: 36px;
        height: 36px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        color: #667eea;
        font-size: 20px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

        .btn-cantidad:hover {
            background: #f0f3ff;
            border-color: #667eea;
        }

    .cantidad-input {
        width: 80px;
        height: 36px;
        text-align: center;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
    }

        .cantidad-input:focus {
            outline: none;
            border-color: #667eea;
        }

    .error-message {
        padding: 12px;
        background: #fee2e2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        color: #991b1b;
        font-size: 14px;
        margin-top: 16px;
    }

        .error-message p {
            margin: 0;
        }

    .success-message {
        padding: 12px;
        background: #d1fae5;
        border: 1px solid #a7f3d0;
        border-radius: 8px;
        color: #065f46;
        font-size: 14px;
        margin-top: 16px;
    }

        .success-message p {
            margin: 0;
        }

    .modal-footer {
        display: flex;
        gap: 12px;
        padding: 20px;
        border-top: 1px solid #e5e7eb;
    }

    .btn-secondary, .btn-primary {
        flex: 1;
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
    }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
</style>

@code {
    [Parameter] public int IdArticulo { get; set; }
    [Parameter] public bool mostrarModal { get; set; }
    [Parameter] public EventCallback OnCerrar { get; set; }

    private ArticuloDetalleDTO? articuloDetalle;
    private bool cargando = false;
    private string? errorMessage;
    private string? mensajeError;
    private bool mostrarExito = false;
    private bool agregando = false;

    private List<string> tallasDisponibles = new();
    private List<string> coloresDisponibles = new();
    private string? tallaSeleccionada;
    private string? colorSeleccionado;
    private VarianteDetalleDTO? varianteSeleccionada;
    private int cantidad = 1;

    protected override async Task OnParametersSetAsync()
    {
        if (mostrarModal && IdArticulo > 0 && articuloDetalle == null)
        {
            await CargarArticulo();
        }
    }

    private async Task CargarArticulo()
    {
        try
        {
            cargando = true;
            errorMessage = null;

            var response = await ArticuloDAO.ObtenerArticuloPorId(IdArticulo);

            if (response.IsSuccess && response.Object != null)
            {
                articuloDetalle = response.Object;

                // Obtener tallas únicas
                tallasDisponibles = articuloDetalle.Variantes
                    .Where(v => v.Estado == "A" && v.Stock > 0)
                    .Select(v => v.Talla)
                    .Distinct()
                    .OrderBy(t => t)
                    .ToList();
            }
            else
            {
                errorMessage = response.Message ?? "Error al cargar el artículo";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            cargando = false;
        }
    }

    private void SeleccionarTalla(string talla)
    {
        tallaSeleccionada = talla;
        colorSeleccionado = null;
        varianteSeleccionada = null;
        mensajeError = null;

        // Obtener colores disponibles para esta talla
        if (articuloDetalle != null)
        {
            coloresDisponibles = articuloDetalle.Variantes
                .Where(v => v.Talla == talla && v.Estado == "A" && v.Stock > 0)
                .Select(v => v.Color)
                .Distinct()
                .OrderBy(c => c)
                .ToList();
        }
    }

    private void SeleccionarColor(string color)
    {
        colorSeleccionado = color;
        mensajeError = null;

        // Buscar la variante específica
        if (articuloDetalle != null && !string.IsNullOrEmpty(tallaSeleccionada))
        {
            varianteSeleccionada = articuloDetalle.Variantes
                .FirstOrDefault(v => v.Talla == tallaSeleccionada
                                  && v.Color == color
                                  && v.Estado == "A"
                                  && v.Stock > 0);

            if (varianteSeleccionada != null)
            {
                // Ajustar cantidad si excede el stock
                if (cantidad > varianteSeleccionada.Stock)
                {
                    cantidad = varianteSeleccionada.Stock;
                }
            }
        }
    }

    private void AumentarCantidad()
    {
        if (varianteSeleccionada != null && cantidad < varianteSeleccionada.Stock)
        {
            cantidad++;
        }
    }

    private void DisminuirCantidad()
    {
        if (cantidad > 1)
        {
            cantidad--;
        }
    }

    private void AgregarAlCarrito()
    {
        if (articuloDetalle == null || varianteSeleccionada == null)
        {
            mensajeError = "Selecciona una talla y color";
            return;
        }

        if (cantidad <= 0 || cantidad > varianteSeleccionada.Stock)
        {
            mensajeError = "Cantidad inválida";
            return;
        }

        try
        {
            agregando = true;
            mensajeError = null;

            var item = new CarritoItemDTO
            {
                IdVariante = varianteSeleccionada.IdVariante,
                IdArticulo = articuloDetalle.IdArticulo,
                NombreArticulo = articuloDetalle.Nombre,
                Marca = articuloDetalle.Marca,
                Talla = varianteSeleccionada.Talla,
                Color = varianteSeleccionada.Color,
                CodigoSKU = varianteSeleccionada.CodigoSKU,
                PrecioUnitario = articuloDetalle.PrecioBase,
                Cantidad = cantidad,
                StockDisponible = varianteSeleccionada.Stock,
                ImagenUrl = articuloDetalle.Imagenes.FirstOrDefault()?.Url
            };

            Carrito.AgregarItem(item);

            // Mostrar mensaje de éxito
            mostrarExito = true;

            // Cerrar modal después de 1 segundo
            Task.Delay(1000).ContinueWith(_ =>
            {
                InvokeAsync(async () =>
                {
                    await Cerrar();
                });
            });
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al agregar: {ex.Message}";
        }
        finally
        {
            agregando = false;
        }
    }

    private async Task Cerrar()
    {
        mostrarModal = false;
        articuloDetalle = null;
        tallaSeleccionada = null;
        colorSeleccionado = null;
        varianteSeleccionada = null;
        cantidad = 1;
        mensajeError = null;
        mostrarExito = false;
        await OnCerrar.InvokeAsync();
    }
}
