@using ENTITY.Articulos
@using ENTITY.Pedidos
@using DAL.Interfaces
@using GUI.Services
@inject IArticuloDAO ArticuloDAO
@inject CarritoService Carrito

@if (mostrarModal)
{
    <div class="modal-overlay" @onclick="Cerrar">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>Agregar al Carrito</h3>
                <button class="btn-close" @onclick="Cerrar">✕</button>
            </div>

            <div class="modal-body">
                @if (cargando)
                {
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando variantes...</p>
                    </div>
                }
                else if (errorMessage != null)
                {
                    <div class="error-message">
                        <p>❌ @errorMessage</p>
                    </div>
                }
                else if (articuloDetalle != null)
                {
                    <div class="producto-info">
                        <h4>@articuloDetalle.Nombre</h4>
                        <p class="marca">@articuloDetalle.Marca</p>
                        <p class="precio">@articuloDetalle.PrecioBase.ToString("C")</p>
                    </div>

                    <div class="form-group">
                        <label>Talla</label>
                        <div class="opciones-grid">
                            @foreach (var talla in tallasDisponibles)
                            {
                                <button class="opcion-btn @(tallaSeleccionada == talla ? "active" : "")"
                                        @onclick="() => SeleccionarTalla(talla)">
                                    @talla
                                </button>
                            }
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(tallaSeleccionada))
                    {
                        <div class="form-group">
                            <label>Color</label>
                            <div class="opciones-grid">
                                @foreach (var color in coloresDisponibles)
                                {
                                    <button class="opcion-btn @(colorSeleccionado == color ? "active" : "")"
                                            @onclick="() => SeleccionarColor(color)">
                                        @color
                                    </button>
                                }
                            </div>
                        </div>
                    }

                    @if (varianteSeleccionada != null)
                    {
                        <div class="stock-info">
                            <p>
                                <strong>Stock disponible:</strong> @varianteSeleccionada.Stock unidades
                            </p>
                            <p class="sku">SKU: @varianteSeleccionada.CodigoSKU</p>
                        </div>

                        <div class="form-group">
                            <label>Cantidad</label>
                            <div class="cantidad-controls">
                                <button class="btn-cantidad" @onclick="DisminuirCantidad">−</button>
                                <input type="number"
                                       class="cantidad-input"
                                       @bind="cantidad"
                                       min="1"
                                       max="@varianteSeleccionada.Stock" />
                                <button class="btn-cantidad" @onclick="AumentarCantidad">+</button>
                            </div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(mensajeError))
                    {
                        <div class="error-message">
                            <p>❌ @mensajeError</p>
                        </div>
                    }

                    @if (mostrarExito)
                    {
                        <div class="success-message">
                            <p>✓ Producto agregado al carrito</p>
                        </div>
                    }
                }
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" @onclick="Cerrar">
                    Cancelar
                </button>
                <button class="btn-primary"
                        @onclick="AgregarAlCarrito"
                        disabled="@(varianteSeleccionada == null || agregando)">
                    @if (agregando)
                    {
                        <span>Agregando...</span>
                    }
                    else
                    {
                        <span>🛒 Agregar al Carrito</span>
                    }
                </button>
            </div>
        </div>
    </div>
}


@code {
    [Parameter] public int IdArticulo { get; set; }
    [Parameter] public bool mostrarModal { get; set; }
    [Parameter] public EventCallback OnCerrar { get; set; }

    private ArticuloDetalleDTO? articuloDetalle;
    private bool cargando = false;
    private string? errorMessage;
    private string? mensajeError;
    private bool mostrarExito = false;
    private bool agregando = false;

    private List<string> tallasDisponibles = new();
    private List<string> coloresDisponibles = new();
    private string? tallaSeleccionada;
    private string? colorSeleccionado;
    private VarianteDetalleDTO? varianteSeleccionada;
    private int cantidad = 1;

    protected override async Task OnParametersSetAsync()
    {
        if (mostrarModal && IdArticulo > 0 && articuloDetalle == null)
        {
            await CargarArticulo();
        }
    }

    private async Task CargarArticulo()
    {
        try
        {
            cargando = true;
            errorMessage = null;

            var response = await ArticuloDAO.ObtenerArticuloPorId(IdArticulo);

            if (response.IsSuccess && response.Object != null)
            {
                articuloDetalle = response.Object;

                tallasDisponibles = articuloDetalle.Variantes
                    .Where(v => v.Estado == "A" && v.Stock > 0)
                    .Select(v => v.Talla)
                    .Distinct()
                    .OrderBy(t => t)
                    .ToList();
            }
            else
            {
                errorMessage = response.Message ?? "Error al cargar el artículo";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            cargando = false;
        }
    }

    private void SeleccionarTalla(string talla)
    {
        tallaSeleccionada = talla;
        colorSeleccionado = null;
        varianteSeleccionada = null;
        mensajeError = null;

        if (articuloDetalle != null)
        {
            coloresDisponibles = articuloDetalle.Variantes
                .Where(v => v.Talla == talla && v.Estado == "A" && v.Stock > 0)
                .Select(v => v.Color)
                .Distinct()
                .OrderBy(c => c)
                .ToList();
        }
    }

    private void SeleccionarColor(string color)
    {
        colorSeleccionado = color;
        mensajeError = null;

        if (articuloDetalle != null && !string.IsNullOrEmpty(tallaSeleccionada))
        {
            varianteSeleccionada = articuloDetalle.Variantes
                .FirstOrDefault(v => v.Talla == tallaSeleccionada
                                  && v.Color == color
                                  && v.Estado == "A"
                                  && v.Stock > 0);

            if (varianteSeleccionada != null)
            {
                if (cantidad > varianteSeleccionada.Stock)
                {
                    cantidad = varianteSeleccionada.Stock;
                }
            }
        }
    }

    private void AumentarCantidad()
    {
        if (varianteSeleccionada != null && cantidad < varianteSeleccionada.Stock)
        {
            cantidad++;
        }
    }

    private void DisminuirCantidad()
    {
        if (cantidad > 1)
        {
            cantidad--;
        }
    }

    private void AgregarAlCarrito()
    {
        if (articuloDetalle == null || varianteSeleccionada == null)
        {
            mensajeError = "Selecciona una talla y color";
            return;
        }

        if (cantidad <= 0 || cantidad > varianteSeleccionada.Stock)
        {
            mensajeError = "Cantidad inválida";
            return;
        }

        try
        {
            agregando = true;
            mensajeError = null;

            var item = new CarritoItemDTO
            {
                IdVariante = varianteSeleccionada.IdVariante,
                IdArticulo = articuloDetalle.IdArticulo,
                NombreArticulo = articuloDetalle.Nombre,
                Marca = articuloDetalle.Marca,
                Talla = varianteSeleccionada.Talla,
                Color = varianteSeleccionada.Color,
                CodigoSKU = varianteSeleccionada.CodigoSKU,
                PrecioUnitario = articuloDetalle.PrecioBase,
                Cantidad = cantidad,
                StockDisponible = varianteSeleccionada.Stock,
                ImagenUrl = articuloDetalle.Imagenes.FirstOrDefault()?.Url
            };

            Carrito.AgregarItem(item);
            mostrarExito = true;

            Task.Delay(1000).ContinueWith(_ =>
            {
                InvokeAsync(async () =>
                {
                    await Cerrar();
                });
            });
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al agregar: {ex.Message}";
        }
        finally
        {
            agregando = false;
        }
    }

    private async Task Cerrar()
    {
        mostrarModal = false;
        articuloDetalle = null;
        tallaSeleccionada = null;
        colorSeleccionado = null;
        varianteSeleccionada = null;
        cantidad = 1;
        mensajeError = null;
        mostrarExito = false;
        await OnCerrar.InvokeAsync();
    }
}
