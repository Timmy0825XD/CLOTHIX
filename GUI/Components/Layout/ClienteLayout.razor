@using BLL.Interfaces
@using ENTITY.Usuarios
@using GUI.Services
@inject IUsuarioService UsuarioService
@inherits LayoutComponentBase
@inject CarritoService Carrito
@inject NavigationManager Navigation
@implements IDisposable

<div class="layout-container">
    <div class="page">
        <aside class="sidebar @(isMenuVisible ? "" : "collapsed")">
            <ClienteMenu />
        </aside>
        <main class="main-content @(isMenuVisible ? "" : "expanded")">
            <div class="header">
                <div class="header-left">
                    <button class="btn-toggle" @onclick="ToggleMenu">
                        @(isMenuVisible ? "✕" : "☰")
                    </button>
                    <div class="header-brand">
                        <span class="brand-icon">🛍️</span>
                        <span class="brand-text">Tienda JOSSAN</span>
                    </div>
                </div>

                <div class="header-center">
                    <div class="search-bar">
                        <span class="search-icon">🔍</span>
                        <input type="text" placeholder="Buscar productos..." class="search-input" />
                    </div>
                </div>

                <div class="header-right">
                    <button class="btn-carrito" @onclick="IrAlCarrito">
                        🛒 Carrito
                        @if (cantidadCarrito > 0)
                        {
                            <span class="carrito-badge">@cantidadCarrito</span>
                        }
                    </button>
                    <div class="user-menu">
                        <div class="user-avatar">@GetInitials(UserDisplayName)</div>
                        <div class="user-info">
                            <div class="user-name">@UserDisplayName</div>
                            <div class="user-role">Cliente</div>
                        </div>
                    </div>
                </div>
            </div>
            <article class="content" style="overflow-y:auto">
                @Body
            </article>
        </main>
    </div>
</div>

@code {
    private string UserDisplayName { get; set; } = "Cliente";
    private bool isMenuVisible = false;
    private int cantidadCarrito = 0;

    protected override void OnInitialized()
    {
        Carrito.OnChange += ActualizarContadorCarrito;
        ActualizarContadorCarrito();
    }

    private void ToggleMenu()
    {
        isMenuVisible = !isMenuVisible;
    }

    private void ActualizarContadorCarrito()
    {
        cantidadCarrito = Carrito.ObtenerCantidadTotal();
        StateHasChanged();
    }

    private void IrAlCarrito()
    {
        Navigation.NavigateTo("/carrito");
    }

    public void Dispose()
    {
        Carrito.OnChange -= ActualizarContadorCarrito;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            UserDisplayName = UsuarioService.ObtenerNombreUsuario();
        }
        catch (Exception ex)
        {
            UserDisplayName = "Usuario";
            Console.WriteLine($"Error al obtener nombre: {ex.Message}");
        }
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "CL";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();

        return name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name.ToUpper();
    }
}